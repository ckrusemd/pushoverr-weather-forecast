---
title: "Pushoverr Weather Forecast"
author: "Christian Kruse"
date: "`r Sys.Date()`"
output: html_document
---

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
```

# Pushoverr Weather Forecast

```{r}

if (!require(pacman)) { install.packages("pacman") }
pacman::p_load(pushoverr,
               dplyr,
               tidyr,
               lubridate,
               scales,
               httr,
               ggplot2,
               suncalc,
               glue,
               hms,
               stringr,
               data.table)

```


```{r warning=FALSE,message=FALSE,include=FALSE}
readRenviron(path = "Renviron.site")
OPENWEATHERMAP_APIKEY = Sys.getenv("OPENWEATHERMAP_APIKEY")
pushoverr::set_pushover_app(token = Sys.getenv("PUSHOVER_APPKEY"))
pushoverr::set_pushover_user(user = Sys.getenv("PUSHOVER_USERKEY"))

```

```{r eval=F}
pushoverr::pushover("Hello world")
```


```{r}
convert_timestamp = function(timestamp) {
  return( as.POSIXct( timestamp ,tz = "Europe/Copenhagen",origin="1970-01-01") )
}
```

```{r}
convert_dataframe_timestamps = function(df) {
  df$dt = convert_timestamp(df$dt)
  df$sunrise = convert_timestamp(df$sunrise)
  df$sunset = convert_timestamp(df$sunset)
  df$moonrise = convert_timestamp(df$moonrise)
  df$moonset = convert_timestamp(df$moonset)
  return( df )
}
```

```{r}
wind_angle_to_compass = function(angle)  {
    val = (angle + 11.25)/22.5
    arr = c("N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW")
    return( arr[(val %% 16)] )
}
```

```{r}
convert_kelvin= function(kelvin) {
  return( kelvin - 273.15 )
}
```


```{r include=TRUE}

lat = 55.771979
lon = 12.494786

res = GET(paste0("https://api.openweathermap.org/data/2.5/onecall?lat=",lat,"&lon=",lon,"&appid=",OPENWEATHERMAP_APIKEY)) # Yeah, should really hide that api key.

res_json = jsonlite::fromJSON( rawToChar( res$content ) )

res_json_current = res_json$current
res_json_daily = res_json$daily
res_json_hourly = res_json$hourly
res_json_minutely = res_json$minutely

res_json_daily = convert_dataframe_timestamps(res_json_daily)
res_json_current = convert_dataframe_timestamps(res_json_current)
res_json_hourly$dt = convert_timestamp(res_json_hourly$dt)
res_json_minutely$dt = convert_timestamp(res_json_minutely$dt)

res_json_current$temp = convert_kelvin( res_json_current$temp )
res_json_current$feels_like = convert_kelvin( res_json_current$feels_like )
res_json_current$dew_point = convert_kelvin( res_json_current$dew_point )

res_json_hourly$temp = convert_kelvin( res_json_hourly$temp )
res_json_hourly$feels_like = convert_kelvin( res_json_hourly$feels_like )
res_json_hourly$dew_point = convert_kelvin( res_json_hourly$dew_point )
```

# Openweather: Current Weather

So you don't need to look out the window. :-)

* Time: ```r res_json_current$dt ```
* Weather Description: ```r res_json_current$weather$description ```
* Temperature (C): ```r res_json_current$temp ```
* Feels Like (C): ```r res_json_current$feels_like ```
* Pressure (hPa): ```r res_json_current$pressure ```
* Humidity: ```r res_json_current$humidity ```
* Dew Point: ```r res_json_current$dew_point ```
* UVI Index: ```r res_json_current$uvi ```
* Clouds: ```r res_json_current$clouds ```
* Visibility: ```r res_json_current$visibility ```
* Wind Speed: ```r res_json_current$wind_speed ```
* Wind Degree: ```r res_json_current$wind_deg ```
* Wind Direction: ```r wind_angle_to_compass( res_json_current$wind_deg )```

```{r theonewithrain02}
res_json_hourly
```


```{r theonewithrain1}
df.scores = res_json_hourly %>% 
  filter(dt<=lubridate::ymd_hms(paste0(Sys.Date()," 00:00:00"),tz = "Europe/Copenhagen")+lubridate::days(1)) %>% 
  dplyr::mutate(dt=format(dt,"%H:%M")) %>% 
  dplyr::mutate(pop=pop*100)
```


